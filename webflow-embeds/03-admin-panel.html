<!-- 
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  WEBFLOW EMBED #3: ADMIN PANEL
  
  What it does:
  - Create new raffles
  - View all raffles (active, completed, cancelled)
  - Select winners randomly
  - Cancel raffles
  - View participants and transactions
  
  SETUP REQUIRED:
  1. Replace YOUR_SUPABASE_URL with your Supabase Project URL
  2. Replace YOUR_SUPABASE_KEY with your anon public key
  3. Replace YOUR_ADMIN_WALLET with your admin wallet address
  4. Make sure wallet connect embed (#1) is on the same page
  
  SECURITY:
  - Only the admin wallet address can access this panel
  - All actions require wallet connection
  
  How to use in Webflow:
  1. Add wallet connect embed first (01-wallet-connect.html)
  2. Add this embed on a separate admin page
  3. Replace the credentials and admin wallet
  4. Keep this page URL secret!
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
-->

<style>
.admin-container {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.admin-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 32px;
  border-radius: 16px;
  margin-bottom: 32px;
}

.admin-title {
  font-size: 32px;
  font-weight: 800;
  margin: 0 0 8px 0;
}

.admin-subtitle {
  opacity: 0.9;
  margin: 0;
}

.tabs {
  display: flex;
  gap: 8px;
  margin-bottom: 24px;
  border-bottom: 2px solid #e5e7eb;
}

.tab {
  padding: 12px 24px;
  background: none;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  font-size: 16px;
  font-weight: 600;
  color: #6b7280;
  transition: all 0.2s;
}

.tab.active {
  color: #667eea;
  border-bottom-color: #667eea;
}

.tab-content {
  display: none;
}

.tab-content.active {
  display: block;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  font-size: 14px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 8px;
}

.form-input, .form-textarea {
  width: 100%;
  padding: 12px;
  border: 2px solid #e5e7eb;
  border-radius: 8px;
  font-size: 16px;
  transition: border-color 0.2s;
}

.form-input:focus, .form-textarea:focus {
  outline: none;
  border-color: #667eea;
}

.form-textarea {
  resize: vertical;
  min-height: 100px;
}

.btn {
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  transition: transform 0.2s;
}

.btn:hover:not(:disabled) {
  transform: scale(1.02);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.btn-primary {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.btn-success {
  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
  color: white;
}

.btn-danger {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
  color: white;
}

.raffle-list {
  display: grid;
  gap: 16px;
}

.raffle-item {
  background: white;
  border: 2px solid #e5e7eb;
  border-radius: 12px;
  padding: 20px;
}

.raffle-item-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 16px;
}

.raffle-item-title {
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 4px 0;
}

.status-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
}

.status-active {
  background: #d1fae5;
  color: #065f46;
}

.status-completed {
  background: #dbeafe;
  color: #1e40af;
}

.status-cancelled {
  background: #fee2e2;
  color: #991b1b;
}

.raffle-item-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: 12px;
  margin: 16px 0;
}

.stat-small {
  font-size: 12px;
  color: #6b7280;
}

.stat-large {
  font-size: 18px;
  font-weight: 700;
  color: #111827;
}

.action-buttons {
  display: flex;
  gap: 8px;
  margin-top: 16px;
}

.access-denied {
  text-align: center;
  padding: 60px 20px;
}

.loading {
  text-align: center;
  padding: 40px;
  color: #6b7280;
}
</style>

<div class="admin-container">
  <div id="accessCheck">
    <div class="loading">
      <div style="font-size: 48px; margin-bottom: 16px;">üîê</div>
      <div>Checking access...</div>
    </div>
  </div>
  
  <div id="adminPanel" style="display: none;">
    <div class="admin-header">
      <h1 class="admin-title">üé∞ Admin Panel</h1>
      <p class="admin-subtitle">Create and manage raffles</p>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="window.switchTab('create')">‚ûï Create Raffle</button>
      <button class="tab" onclick="window.switchTab('manage')">üìã Manage Raffles</button>
    </div>
    
    <div id="createTab" class="tab-content active">
      <div style="background: white; padding: 32px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
        <h2 style="margin-top: 0;">Create New Raffle</h2>
        
        <form id="createRaffleForm">
          <div class="form-group">
            <label class="form-label">Raffle Title *</label>
            <input type="text" class="form-input" id="title" required placeholder="e.g., 1 ETH Grand Prize Draw">
          </div>
          
          <div class="form-group">
            <label class="form-label">Description *</label>
            <textarea class="form-textarea" id="description" required placeholder="Describe your raffle..."></textarea>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label class="form-label">Prize Pool (ETH) *</label>
              <input type="number" class="form-input" id="prizePool" step="0.001" required placeholder="1.0">
            </div>
            
            <div class="form-group">
              <label class="form-label">Entry Fee (ETH) *</label>
              <input type="number" class="form-input" id="entryFee" step="0.001" required placeholder="0.01">
            </div>
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label class="form-label">Total Spots *</label>
              <input type="number" class="form-input" id="totalSpots" required placeholder="100">
            </div>
            
            <div class="form-group">
              <label class="form-label">Duration (hours) *</label>
              <input type="number" class="form-input" id="duration" required placeholder="24">
            </div>
          </div>
          
          <div class="form-group">
            <label class="form-label">Your Wallet Address (for receiving payments) *</label>
            <input type="text" class="form-input" id="walletAddress" required placeholder="0x...">
          </div>
          
          <button type="submit" class="btn btn-primary" style="width: 100%;">
            üöÄ Create Raffle
          </button>
        </form>
      </div>
    </div>
    
    <div id="manageTab" class="tab-content">
      <div id="rafflesList" class="raffle-list">
        <div class="loading">Loading raffles...</div>
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  // ‚ö†Ô∏è REPLACE THESE WITH YOUR CREDENTIALS
  const SUPABASE_URL = 'YOUR_SUPABASE_URL';
  const SUPABASE_KEY = 'YOUR_SUPABASE_KEY';
  const ADMIN_WALLET = 'YOUR_ADMIN_WALLET'; // e.g., 0x1234...
  
  const api = {
    headers: {
      'apikey': SUPABASE_KEY,
      'Authorization': `Bearer ${SUPABASE_KEY}`,
      'Content-Type': 'application/json',
      'Prefer': 'return=representation'
    },
    
    async createRaffle(data) {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/raffles`, {
        method: 'POST',
        headers: this.headers,
        body: JSON.stringify(data)
      });
      return await response.json();
    },
    
    async getAllRaffles() {
      const response = await fetch(
        `${SUPABASE_URL}/rest/v1/raffles?select=*&order=created_at.desc`,
        { headers: this.headers }
      );
      return await response.json();
    },
    
    async getParticipants(raffleId) {
      const response = await fetch(
        `${SUPABASE_URL}/rest/v1/participants?select=*&raffle_id=eq.${raffleId}`,
        { headers: this.headers }
      );
      return await response.json();
    },
    
    async updateRaffle(raffleId, data) {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/raffles?id=eq.${raffleId}`, {
        method: 'PATCH',
        headers: this.headers,
        body: JSON.stringify(data)
      });
      return await response.json();
    },
    
    async addWinner(data) {
      const response = await fetch(`${SUPABASE_URL}/rest/v1/winners`, {
        method: 'POST',
        headers: this.headers,
        body: JSON.stringify(data)
      });
      return await response.json();
    }
  };
  
  function checkAccess() {
    if (!window.RAFFLE_WALLET || !window.RAFFLE_WALLET.isConnected) {
      document.getElementById('accessCheck').innerHTML = `
        <div class="access-denied">
          <div style="font-size: 64px; margin-bottom: 16px;">üîí</div>
          <h2>Access Denied</h2>
          <p style="color: #6b7280; margin: 16px 0;">Please connect your wallet to access the admin panel.</p>
        </div>
      `;
      return false;
    }
    
    if (window.RAFFLE_WALLET.address.toLowerCase() !== ADMIN_WALLET.toLowerCase()) {
      document.getElementById('accessCheck').innerHTML = `
        <div class="access-denied">
          <div style="font-size: 64px; margin-bottom: 16px;">‚õî</div>
          <h2>Unauthorized</h2>
          <p style="color: #6b7280; margin: 16px 0;">You don't have permission to access this panel.</p>
          <p style="font-size: 14px; color: #9ca3af; font-family: monospace;">Connected: ${window.RAFFLE_WALLET.address}</p>
        </div>
      `;
      return false;
    }
    
    document.getElementById('accessCheck').style.display = 'none';
    document.getElementById('adminPanel').style.display = 'block';
    document.getElementById('walletAddress').value = window.RAFFLE_WALLET.address;
    loadRaffles();
    return true;
  }
  
  window.switchTab = function(tab) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tab + 'Tab').classList.add('active');
    
    if (tab === 'manage') {
      loadRaffles();
    }
  };
  
  document.getElementById('createRaffleForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const button = e.target.querySelector('button[type="submit"]');
    button.disabled = true;
    button.textContent = '‚è≥ Creating...';
    
    try {
      const duration = parseInt(document.getElementById('duration').value);
      const endTime = Date.now() + (duration * 60 * 60 * 1000);
      
      const raffleData = {
        title: document.getElementById('title').value,
        description: document.getElementById('description').value,
        prize_pool: parseFloat(document.getElementById('prizePool').value),
        entry_fee: parseFloat(document.getElementById('entryFee').value),
        total_spots: parseInt(document.getElementById('totalSpots').value),
        wallet_address: document.getElementById('walletAddress').value,
        end_time: endTime,
        status: 'active',
        created_at: Date.now()
      };
      
      await api.createRaffle(raffleData);
      
      alert('‚úÖ Raffle created successfully!');
      e.target.reset();
      document.getElementById('walletAddress').value = window.RAFFLE_WALLET.address;
      
    } catch (error) {
      console.error('Error:', error);
      alert('‚ùå Error creating raffle: ' + error.message);
    } finally {
      button.disabled = false;
      button.textContent = 'üöÄ Create Raffle';
    }
  });
  
  async function selectWinner(raffleId) {
    if (!confirm('üé≤ Select a random winner for this raffle?')) return;
    
    try {
      const participants = await api.getParticipants(raffleId);
      
      if (participants.length === 0) {
        alert('‚ùå No participants in this raffle!');
        return;
      }
      
      // Random selection
      const winner = participants[Math.floor(Math.random() * participants.length)];
      
      // Update raffle status
      await api.updateRaffle(raffleId, { status: 'completed' });
      
      // Add winner
      await api.addWinner({
        raffle_id: raffleId,
        winner_address: winner.address,
        selected_at: Date.now()
      });
      
      alert(`üéâ Winner selected!\n\nAddress: ${winner.address}\n\nPlease send the prize to this address.`);
      loadRaffles();
      
    } catch (error) {
      console.error('Error:', error);
      alert('‚ùå Error selecting winner: ' + error.message);
    }
  }
  
  async function cancelRaffle(raffleId) {
    if (!confirm('‚ö†Ô∏è Cancel this raffle? This cannot be undone.')) return;
    
    try {
      await api.updateRaffle(raffleId, { status: 'cancelled' });
      alert('‚úÖ Raffle cancelled');
      loadRaffles();
    } catch (error) {
      console.error('Error:', error);
      alert('‚ùå Error cancelling raffle: ' + error.message);
    }
  }
  
  async function loadRaffles() {
    try {
      const raffles = await api.getAllRaffles();
      const container = document.getElementById('rafflesList');
      
      if (raffles.length === 0) {
        container.innerHTML = '<div class="loading">No raffles created yet.</div>';
        return;
      }
      
      let html = '';
      
      for (const raffle of raffles) {
        const participants = await api.getParticipants(raffle.id);
        const timeLeft = raffle.end_time - Date.now();
        const isExpired = timeLeft <= 0;
        
        html += `
          <div class="raffle-item">
            <div class="raffle-item-header">
              <div>
                <h3 class="raffle-item-title">${raffle.title}</h3>
                <p style="color: #6b7280; margin: 0;">${raffle.description}</p>
              </div>
              <span class="status-badge status-${raffle.status}">${raffle.status}</span>
            </div>
            
            <div class="raffle-item-stats">
              <div>
                <div class="stat-small">Prize Pool</div>
                <div class="stat-large" style="color: #10b981;">${raffle.prize_pool} ETH</div>
              </div>
              <div>
                <div class="stat-small">Entry Fee</div>
                <div class="stat-large">${raffle.entry_fee} ETH</div>
              </div>
              <div>
                <div class="stat-small">Participants</div>
                <div class="stat-large">${participants.length} / ${raffle.total_spots}</div>
              </div>
              <div>
                <div class="stat-small">Status</div>
                <div class="stat-large" style="font-size: 14px;">${isExpired && raffle.status === 'active' ? '‚è∞ Expired' : raffle.status === 'active' ? '‚úÖ Active' : raffle.status === 'completed' ? 'üèÜ Complete' : '‚ùå Cancelled'}</div>
              </div>
            </div>
            
            ${raffle.status === 'active' ? `
              <div class="action-buttons">
                ${isExpired || participants.length > 0 ? `
                  <button class="btn btn-success" onclick="window.selectWinner('${raffle.id}')">
                    üé≤ Select Winner
                  </button>
                ` : ''}
                <button class="btn btn-danger" onclick="window.cancelRaffle('${raffle.id}')">
                  ‚ùå Cancel Raffle
                </button>
              </div>
            ` : ''}
          </div>
        `;
      }
      
      container.innerHTML = html;
      
    } catch (error) {
      console.error('Error:', error);
      document.getElementById('rafflesList').innerHTML = `
        <div class="loading" style="color: #ef4444;">
          Error loading raffles: ${error.message}
        </div>
      `;
    }
  }
  
  // Make functions globally accessible
  window.selectWinner = selectWinner;
  window.cancelRaffle = cancelRaffle;
  
  // Check access on load
  setTimeout(checkAccess, 500);
  
  // Re-check when wallet connects
  window.addEventListener('walletConnected', checkAccess);
  
  console.log('‚úÖ Admin panel loaded');
})();
</script>